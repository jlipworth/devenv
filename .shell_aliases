#!/bin/bash
# Shell Aliases for Modern CLI Tools
# Managed by devenv repository
# Source this file from your .zshrc or .bashrc
#
# NOTE: These aliases are conditional - they only apply if the tools are installed.
# Install via: make cli_tools

# ======================================================================
# BLESH - Bash syntax highlighting (must be near top, before other config)
# ======================================================================
if [[ -n "$BASH_VERSION" ]]; then
    _blesh_path="${HOME}/.local/share/blesh/ble.sh"
    [[ -f /usr/share/blesh/ble.sh ]] && _blesh_path="/usr/share/blesh/ble.sh"
    if [[ -f "$_blesh_path" ]]; then
        source "$_blesh_path" --attach=none
    fi
    unset _blesh_path
fi

# ======================================================================
# NVM - Node Version Manager (load early so node/npm resolve correctly)
# ======================================================================
if [ -z "$NVM_DIR" ]; then
    export NVM_DIR="$HOME/.nvm"
fi
if command -v brew &> /dev/null; then
    [ -s "$(brew --prefix nvm)/nvm.sh" ] && . "$(brew --prefix nvm)/nvm.sh"
    [ -s "$(brew --prefix nvm)/etc/bash_completion.d/nvm" ] && . "$(brew --prefix nvm)/etc/bash_completion.d/nvm"
elif [ -s "$NVM_DIR/nvm.sh" ]; then
    . "$NVM_DIR/nvm.sh"
fi

# ======================================================================
# WSL - Browser and file opener support
# ======================================================================
if grep -q WSL /proc/version 2>/dev/null; then
    if command -v wslview &> /dev/null; then
        export BROWSER=wslview   # For OAuth flows (gh auth, etc.)
        export OPENER=wslview    # For general file opening
    fi
fi

# ======================================================================
# EZA - Modern ls replacement
# ======================================================================
if command -v eza &> /dev/null; then
    alias ls='eza --icons --group-directories-first'
    alias l='eza -l --icons --group-directories-first --git --header'
    alias la='eza -la --icons --group-directories-first --git --header'
    alias ll='eza -l --icons --group-directories-first --git --header'
    alias lla='eza -la --icons --group-directories-first --git --header'
    # Tree views - show everything by default
    alias lt='eza -T --icons --level=2 --group-directories-first'
    alias lta='eza -Ta --icons --level=2 --group-directories-first'
    alias ltree='eza -T --icons --group-directories-first'

    # Tree views - git-aware (respects .gitignore)
    alias ltg='eza -T --icons --git-ignore --level=2 --group-directories-first'
    alias ltag='eza -Ta --icons --git-ignore --level=2 --group-directories-first'
    alias ltreeg='eza -T --icons --git-ignore --group-directories-first'

    alias l.='eza -ld --icons .*'  # Show only dotfiles
    alias lS='eza -1 --icons'  # Single column
fi

# ======================================================================
# BAT - Cat with syntax highlighting
# ======================================================================
if command -v bat &> /dev/null; then
    alias cat='bat --paging=never'
    alias batp='bat'  # bat with paging enabled
    alias bathelp='bat --plain --language=help'  # Use bat for help pages

    # Helper function for help pages with bat
    help() {
        "$@" --help 2>&1 | bathelp
    }
fi

# ======================================================================
# RIPGREP - Fast grep replacement
# ======================================================================
if command -v rg &> /dev/null; then
    alias rg='rg'    # Explicit, but good for clarity (respects .gitignore by default)
    alias rgi='rg -i'   # Case insensitive
    alias rgl='rg -l'   # List files with matches
    alias rgc='rg -c'   # Count matches
    alias rgall='rg --no-ignore -uuu'  # Search everything, ignore .gitignore and hidden files
fi

# ======================================================================
# FD - Fast find replacement
# ======================================================================
# On Debian/Ubuntu, the package is fd-find and binary is fdfind
if command -v fdfind &> /dev/null && ! command -v fd &> /dev/null; then
    alias fd='fdfind'
    alias fda='fdfind -H'
    alias fdall='fdfind --no-ignore -H'
    alias fde='fdfind -e'
elif command -v fd &> /dev/null; then
    alias fda='fd -H'      # Include hidden files (still respects .gitignore)
    alias fdall='fd --no-ignore -H'  # Show everything, ignore .gitignore
    alias fde='fd -e'      # Search by extension: fde txt
fi

# ======================================================================
# DUST - Better du
# ======================================================================
if command -v dust &> /dev/null; then
    alias du='dust'        # Replace du with dust
    alias dua='dust -d 1'  # Depth 1
    alias dus='dust -r'    # Reverse sort (smallest first)
fi

# ======================================================================
# SD - Modern sed replacement
# ======================================================================
# sd uses regex by default, simpler syntax than sed
# Usage: sd 'pattern' 'replacement' file
# No aliases needed - sd's default interface is already clean

# ======================================================================
# PROCS - Modern ps replacement
# ======================================================================
if command -v procs &> /dev/null; then
    alias ps='procs'
    alias psa='procs --tree'  # Show process tree
    alias psg='procs --keyword'  # Search processes by keyword
fi

# ======================================================================
# RANGER - Terminal file manager
# ======================================================================
if command -v ranger &> /dev/null; then
    alias r='ranger'
fi

# ======================================================================
# FZF - Fuzzy finder
# ======================================================================
if command -v fzf &> /dev/null; then
    # fzf is typically used in scripts/pipelines, not as an alias
    # But we can add some useful patterns here

    # Interactive cd with fzf (uses fd to respect .gitignore by default)
    fcd() {
        local dir
        if command -v fd &> /dev/null; then
            dir=$(fd --type d --hidden ${1:-.} | fzf +m) && cd "$dir"
        else
            dir=$(find ${1:-.} -type d 2> /dev/null | fzf +m) && cd "$dir"
        fi
    }

    # Interactive cd showing ALL directories (ignores .gitignore)
    fcdall() {
        local dir
        if command -v fd &> /dev/null; then
            dir=$(fd --type d --hidden --no-ignore ${1:-.} | fzf +m) && cd "$dir"
        else
            dir=$(find ${1:-.} -type d 2> /dev/null | fzf +m) && cd "$dir"
        fi
    }

    # Open file with fzf (cross-platform)
    fo() {
        local opener="${OPENER:-xdg-open}"
        [[ "$OSTYPE" == "darwin"* ]] && opener="open"
        fzf --print0 | xargs -0 "$opener"
    }
fi

# ======================================================================
# ZOXIDE - Smart cd (already has 'z' command from init)
# ======================================================================
# zoxide provides: z, zi (interactive) via eval "$(zoxide init)"
# These are set up automatically in cli_tools installation
# Optional: Make cd use zoxide (uncomment if desired)
# if command -v zoxide &> /dev/null; then
#     alias cd='z'
# fi

# ======================================================================
# LAZYGIT - Git TUI
# ======================================================================
if command -v lazygit &> /dev/null; then
    alias lg='lazygit'
    alias lzg='lazygit'
fi

# ======================================================================
# GIT-DELTA - Better diffs
# ======================================================================
if command -v delta &> /dev/null; then
    # Note: These create pipelines, so we use functions instead of aliases
    diffview() {
        diff -u "$@" | delta
    }

    diffside() {
        diff -u "$@" | delta --side-by-side
    }
fi

# ======================================================================
# HTOP - Process viewer
# ======================================================================
if command -v htop &> /dev/null; then
    alias top='htop'
fi

# ======================================================================
# Useful Functions (always available)
# ======================================================================

# Create directory and cd into it
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Extract archives easily
extract() {
    if [ -f "$1" ] ; then
        case "$1" in
            *.tar.bz2)   tar xjf "$1"     ;;
            *.tar.gz)    tar xzf "$1"     ;;
            *.bz2)       bunzip2 "$1"     ;;
            *.rar)       unrar x "$1"     ;;
            *.gz)        gunzip "$1"      ;;
            *.tar)       tar xf "$1"      ;;
            *.tbz2)      tar xjf "$1"     ;;
            *.tgz)       tar xzf "$1"     ;;
            *.zip)       unzip "$1"       ;;
            *.Z)         uncompress "$1"  ;;
            *.7z)        7z x "$1"        ;;
            *)           echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

# ======================================================================
# LIBPQ - PostgreSQL client (keg-only, needs PATH)
# ======================================================================
# libpq is keg-only so we need to add it to PATH manually
if [ -d "/home/linuxbrew/.linuxbrew/opt/libpq/bin" ]; then
    export PATH="/home/linuxbrew/.linuxbrew/opt/libpq/bin:$PATH"
elif [ -d "/opt/homebrew/opt/libpq/bin" ]; then
    export PATH="/opt/homebrew/opt/libpq/bin:$PATH"
elif [ -d "/usr/local/opt/libpq/bin" ]; then
    export PATH="/usr/local/opt/libpq/bin:$PATH"
fi

# ======================================================================
# TMUX - Terminal multiplexer
# ======================================================================
if command -v tmux &> /dev/null; then
    alias tmuxa='tmux attach'
fi

# ======================================================================
# AI CLI Tools
# ======================================================================
if command -v claude &> /dev/null; then
    alias claud='claude --dangerously-skip-permissions'
fi

if command -v codex &> /dev/null; then
    alias codey='codex --yolo'
fi

# ======================================================================
# User Customization Area
# ======================================================================
# Add your own aliases and functions below this line
# They will be preserved across updates

# Examples:
# alias proj='cd ~/projects'

# ======================================================================
# BLESH - Attach (must be at very end of shell config)
# ======================================================================
if [[ -n "$BASH_VERSION" ]]; then
    [[ ! ${BLE_VERSION-} ]] || ble-attach
fi

# ======================================================================
# ZSH-VI-MODE (enhanced vi mode for zsh - cursor shapes, text objects)
# ======================================================================
if [[ -n "$ZSH_VERSION" ]]; then
    # Config function called automatically before plugin initializes
    function zvm_config() {
        ZVM_VI_INSERT_ESCAPE_BINDKEY=jk
        ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT
        ZVM_INIT_MODE=sourcing
    }
    # Custom keybindings applied after plugin initializes
    function zvm_after_init() {
        zvm_bindkey viins '^?' backward-delete-char
        zvm_bindkey viins '^H' backward-delete-char
        zvm_bindkey viins '^W' backward-kill-word
        zvm_bindkey viins '^U' backward-kill-line
    }
    for _zsh_vm_path in \
        "$(brew --prefix 2>/dev/null)/opt/zsh-vi-mode/share/zsh-vi-mode/zsh-vi-mode.plugin.zsh" \
        "/usr/share/zsh/plugins/zsh-vi-mode/zsh-vi-mode.plugin.zsh" \
        "${HOME}/.local/share/zsh-vi-mode/zsh-vi-mode.plugin.zsh"; do
        if [[ -f "$_zsh_vm_path" ]]; then
            source "$_zsh_vm_path"
            break
        fi
    done
    unset _zsh_vm_path
fi

# ======================================================================
# ZSH-AUTOSUGGESTIONS (fish-style history suggestions for zsh)
# ======================================================================
if [[ -n "$ZSH_VERSION" ]]; then
    for _zsh_as_path in \
        "$(brew --prefix 2>/dev/null)/share/zsh-autosuggestions/zsh-autosuggestions.zsh" \
        "/usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh"; do
        if [[ -f "$_zsh_as_path" ]]; then
            source "$_zsh_as_path"
            break
        fi
    done
    unset _zsh_as_path
fi

# ======================================================================
# ZSH-SYNTAX-HIGHLIGHTING (must be at very end for zsh)
# ======================================================================
if [[ -n "$ZSH_VERSION" ]]; then
    for _zsh_hl_path in \
        "$(brew --prefix 2>/dev/null)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" \
        "/usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"; do
        if [[ -f "$_zsh_hl_path" ]]; then
            source "$_zsh_hl_path"
            break
        fi
    done
    unset _zsh_hl_path
fi
